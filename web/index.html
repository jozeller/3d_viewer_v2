<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>3D Viewer</title>

  <!-- Cesium (CDN) -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.137/Build/Cesium/Cesium.js"></script>
  <link
    href="https://cesium.com/downloads/cesiumjs/releases/1.137/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <!-- Fullscreen map behind everything -->
  <div id="mapWrap">
    <div id="cesiumContainer"></div>
    <div id="invisibleCredits" style="display:none;"></div>
  </div>

  <!-- Backdrop -->
  <div id="drawerBackdrop" class="is-hidden" aria-hidden="true"></div>

  <!-- Left overlay menu -->
  <aside id="drawer" class="is-hidden" aria-label="Menu">
    <!-- Header -->
    <header class="drawerHeader">
      <div class="drawerBrand">
        <div class="drawerTitleMain" data-i18n="appTitle">3D Viewer</div>
        <div class="drawerTitleRow">
          <div id="regionDropdown" class="regionDropdown" aria-label="Select Region">
            <button id="regionToggle" class="regionToggle" type="button">
              <span id="regionFlag" class="regionFlag"></span>
              <span id="regionName" class="regionNameText"></span>
              <span class="regionArrow">▼</span>
            </button>
            <ul id="regionOptions" class="regionOptions is-hidden">
              <!-- Populated by JS -->
            </ul>
          </div>
        </div>
      </div>
      <div class="drawerHeaderActions">
        <button class="infoBtnHeader" type="button" aria-label="Hilfe">?</button>
        <button
          id="drawerToggle"
          class="fab fabInDrawer"
          type="button"
          aria-label="Menu"
        >
          ✖
        </button>
      </div>
    </header>

    <!-- Scrollable main section -->
    <section class="section sectionScroll">
      <div id="infoPanel" class="infoPanelDropdown is-hidden">
        <div class="infoPanelContent">
          <p><strong data-i18n="baseMaps">Base Maps:</strong> <span data-i18n="selectBaseMap">Select a base map</span></p>
          <p><strong data-i18n="analysisLayers">Analysis Layers:</strong> <span data-i18n="multipleLayers">Multiple layers can be displayed simultaneously</span></p>
          <p><strong data-i18n="hazardMaps">Hazard Maps:</strong> <span data-i18n="overlayInfo">Overlay additional information</span></p>
          <p><strong data-i18n="transparency">Transparency:</strong> <span data-i18n="adjustOpacity">Adjust the opacity of layers</span></p>
          <hr class="infoDivider" />
          <p><strong data-i18n="myTours">My Tours:</strong> <span data-i18n="myToursDesc">Log in to create tours, upload GPX tracks, and share them with others</span></p>
          <hr class="infoDivider" />
          <div class="performanceControl">
            <label for="performanceMode" data-i18n="performance">Performance:</label>
            <select id="performanceMode" class="performanceSelect">
              <option value="auto" data-i18n="auto">Auto</option>
              <option value="low" data-i18n="powerSaver">Power Saver</option>
              <option value="medium" data-i18n="balanced">Balanced</option>
              <option value="high" data-i18n="highQuality">High Quality</option>
            </select>
            <span id="performanceTierLabel" class="performanceTierLabel"></span>
          </div>
        </div>
      </div>

      <div class="drawer-nav">
        <button id="navLegend" class="navBtn is-active" type="button" data-i18n="legend">Legend</button>
        <button id="navMyTours" class="navBtn is-hidden" type="button" data-i18n="myTours">My Tours</button>
      </div>

      <div id="viewLegend">
        <ul id="legend" class="legendList"></ul>
      </div>

      <div id="viewMyTours" class="is-hidden">
        <div class="myToursHeader">
          <button id="createTourBtn" class="pillBtn" type="button" data-i18n="createTour">+ Create Tour</button>
          <form id="newTourForm" class="is-hidden">
            <input id="newTourTitle" placeholder="Tour name" required data-i18n="tourName" />
            <button type="submit" class="pillBtn" data-i18n="create">Create</button>
            <button type="button" id="cancelTourBtn" class="pillBtn pillBtnGhost" data-i18n="cancel">Cancel</button>
          </form>
        </div>

        <div id="toursList"></div>
      </div>
    </section>

    <!-- Footer: auth area always at the bottom -->
    <footer class="drawerFooter">
      <div class="footerDivider"></div>

      <!-- Logged out -->
      <div id="authFooterLoggedOut" class="authFooterRow">
        <button id="languageToggleBtn" class="languageToggleBtn" type="button">DE</button>
        <button id="authOpenLogin" class="pillBtn" type="button" data-i18n="login">Login</button>
      </div>

      <!-- Auth panel (login / register) -->
      <section id="authPanel" class="authPanel is-hidden" aria-label="Authentication">
        <div class="drawer-nav" role="tablist" aria-label="Auth">
          <button
            id="tabLogin"
            class="navBtn is-active"
            type="button"
            role="tab"
            aria-selected="true"
            data-i18n="login"
          >
            Login
          </button>
          <button
            id="tabRegister"
            class="navBtn"
            type="button"
            role="tab"
            aria-selected="false"
            data-i18n="register"
          >
            Register
          </button>
        </div>

        <div class="authBox">
          <div class="authRow">
            <label class="authLabel" for="authEmail" data-i18n="email">Email</label>
            <input
              id="authEmail"
              class="authInput"
              type="email"
              autocomplete="email"
            />
          </div>

          <div class="authRow">
            <label class="authLabel" for="authPassword" data-i18n="password">Password</label>
            <input
              id="authPassword"
              class="authInput"
              type="password"
              autocomplete="current-password"
            />
          </div>

          <!-- Register only -->
          <div class="authRow is-hidden" id="rowName">
            <label class="authLabel" for="authName" data-i18n="nameOptional">Name (optional)</label>
            <input
              id="authName"
              class="authInput"
              type="text"
              autocomplete="name"
            />
          </div>

          <div class="authActions">
            <button
              id="btnPrimary"
              class="pillBtn"
              type="button"
            >
              Login
            </button>
            <button
              id="btnForgotPw"
              class="textBtn is-visible"
              type="button"
              data-i18n="forgotPassword"
            >
              Forgot password?
            </button>
          </div>
          <div id="authMsg" class="authMsg" aria-live="polite"></div>
        </div>
      </section>

      <!-- Logged in -->
      <div id="authFooterLoggedIn" class="authFooterRow is-hidden">
        <div id="authFooterIdentity" class="authFooterIdentity">
          Willkommen
        </div>
        <button
          id="authLogoutBtn"
          class="pillBtn pillBtnDanger"
          type="button"
          data-i18n="logout"
        >
          Logout
        </button>
      </div>
    </footer>
  </aside>

  <!-- Burger toggle (only visible when drawer is closed) -->
  <button
    id="drawerToggleBurger"
    class="fab fabBurger"
    type="button"
    aria-label="Menu"
  >
    ☰
  </button>

  <!-- Locator button (bottom right) -->
  <button
    id="locatorBtn"
    class="fab fabLocator"
    type="button"
    data-i18n-aria="myLocation"
    data-i18n-title="myLocation"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="4"/>
      <line x1="12" y1="2" x2="12" y2="6"/>
      <line x1="12" y1="18" x2="12" y2="22"/>
      <line x1="2" y1="12" x2="6" y2="12"/>
      <line x1="18" y1="12" x2="22" y2="12"/>
    </svg>
  </button>

  <!-- Share Modal Overlay -->
  <div id="shareModal" class="shareModal is-hidden" aria-modal="true" role="dialog">
    <div class="shareModalBackdrop"></div>
    <div class="shareModalContent">
      <div class="shareModalHeader">
        <h2 class="shareModalTitle" data-i18n="shareTour">Share Tour</h2>
        <button class="shareModalClose" type="button" aria-label="Close" title="Schließen">✖</button>
      </div>
      <div class="shareModalBody">
        <p class="shareModalHint" data-i18n="shareHint">Enter one or more email addresses (one per line or separated by commas):</p>
        <textarea id="shareModalEmails" class="shareModalTextarea" placeholder="email@example.com&#10;another@example.com" rows="4"></textarea>
        <div id="shareModalResults" class="shareModalResults"></div>
      </div>
      <div class="shareModalFooter">
        <button id="shareModalCancel" class="pillBtn pillBtnGhost" type="button" data-i18n="cancel">Cancel</button>
        <button id="shareModalSubmit" class="pillBtn" type="button" data-i18n="share">Share</button>
      </div>
    </div>
  </div>

  <!-- Confirm/Alert Modal Overlay -->
  <div id="confirmModal" class="confirmModal is-hidden" aria-modal="true" role="alertdialog">
    <div class="confirmModalBackdrop"></div>
    <div class="confirmModalContent">
      <div class="confirmModalIcon" id="confirmModalIcon">⚠️</div>
      <h2 class="confirmModalTitle" id="confirmModalTitle" data-i18n="confirm">Confirm</h2>
      <p class="confirmModalMessage" id="confirmModalMessage" data-i18n="areYouSure">Are you sure?</p>
      <div class="confirmModalFooter">
        <button id="confirmModalCancel" class="pillBtn pillBtnGhost" type="button" data-i18n="cancel">Cancel</button>
        <button id="confirmModalConfirm" class="pillBtn pillBtnDanger" type="button" data-i18n="confirm">Confirm</button>
      </div>
    </div>
  </div>

  <script src="./translations.js"></script>
  <script type="module" src="./main.js"></script>

  <script>
    const toggleBurger = document.getElementById('drawerToggleBurger');
    const toggleX = document.getElementById('drawerToggle');
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('drawerBackdrop');
    const infoBtn = document.querySelector('.infoBtnHeader');
    const infoPanel = document.getElementById('infoPanel');
    const authPanelEl = document.getElementById('authPanel');

    // Fix for mobile browsers with dynamic address bar (Chrome on Android, Safari on iOS)
    // Sets a CSS variable with the actual visible height
    function setMobileVh() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setMobileVh();
    window.addEventListener('resize', setMobileVh);
    // Also update on orientation change
    window.addEventListener('orientationchange', () => {
      setTimeout(setMobileVh, 100);
    });

    function openDrawer() {
      drawer.classList.remove('is-hidden');
      backdrop.classList.remove('is-hidden');
      document.body.classList.add('drawer-open');
      toggleBurger.style.display = 'none';
      // Update vh when drawer opens (in case browser UI changed)
      setMobileVh();
    }

    function closeDrawer() {
      drawer.classList.add('is-hidden');
      backdrop.classList.add('is-hidden');
      document.body.classList.remove('drawer-open');
      toggleBurger.style.display = 'block';
      if (authPanelEl) {
        authPanelEl.classList.add('is-hidden');
        authPanelEl.classList.add('hidden');
      }
    }

    function toggleInfo() {
      infoPanel.classList.toggle('is-hidden');
    }

    toggleBurger.addEventListener('click', openDrawer);
    toggleX.addEventListener('click', closeDrawer);
    infoBtn.addEventListener('click', toggleInfo);

    // backdrop soll das Menü nicht mehr schließen
    // backdrop.addEventListener('click', closeDrawer);

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeDrawer();
    });
  </script>
</body>
</html>